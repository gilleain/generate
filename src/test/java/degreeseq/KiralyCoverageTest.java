package degreeseq;

import generate.handler.IsomorphCountingHandler;
import graph.model.Graph;
import graph.model.GraphFileReader;
import graph.model.GraphSignature;
import graph.model.IntGraph;

import java.io.FileNotFoundException;
import java.io.FileReader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.junit.Test;

public class KiralyCoverageTest {
    
    public Map<String, List<Graph>> getDegSeqMap(String filename) throws FileNotFoundException {
        Map<String, List<Graph>> degreeSeqMap = new HashMap<String, List<Graph>>();
        // read the graphs generated by McKay, and group them by degree sequence
        GraphFileReader reader = new GraphFileReader(new FileReader(filename));
        for (IntGraph g : reader) {
            int[] degSeq = g.degreeSequence(true);
            String key = Arrays.toString(degSeq);
            List<Graph> graphsWithDegSeq;
            if (degreeSeqMap.containsKey(key)) {
                graphsWithDegSeq = degreeSeqMap.get(key);
            } else {
                graphsWithDegSeq = new ArrayList<Graph>();
                degreeSeqMap.put(key, graphsWithDegSeq);
            }
            graphsWithDegSeq.add(g);
        }
        return degreeSeqMap;
    }
    
    public void testFile(String filename) throws FileNotFoundException {
        Map<String, List<Graph>> degreeSeqMap = getDegSeqMap(filename); 
        
        // use the degree sequences to re-generate the graphs using KiralyHH
        Map<int[], List<Graph>> missingDegreeSeqMap = new HashMap<int[], List<Graph>>();
        Map<int[], List<Graph>> surplusDegreeSeqMap = new HashMap<int[], List<Graph>>();
        IsomorphCountingHandler duplicateHandler = new IsomorphCountingHandler(true, false);
        KiralyHHGenerator generator = new KiralyHHGenerator(duplicateHandler);
        for (String degreeSequenceString : degreeSeqMap.keySet()) {
            int[] degreeSequence = parse(degreeSequenceString);
            List<Graph> mckaySet = degreeSeqMap.get(degreeSequenceString);
            System.out.print(Arrays.toString(degreeSequence) + "\t" + mckaySet.size());
            generator.generate(degreeSequence);
            List<Graph> kiralySet = duplicateHandler.getNonIsomorphicGraphs();
            if (kiralySet.size() == mckaySet.size()) {
                System.out.println("\tPASS\t" + kiralySet.size());
            } else if (kiralySet.size() > mckaySet.size()){
                System.out.println("\tFAIL\t" + kiralySet.size() );
                surplusDegreeSeqMap.put(degreeSequence, diff(kiralySet, mckaySet));
            } else if (kiralySet.size() < mckaySet.size()){
                System.out.println("\tFAIL\t" + kiralySet.size() );
                missingDegreeSeqMap.put(degreeSequence, diff(kiralySet, mckaySet));
            }
        }
        
        int count = 0;
        for (int[] degSeq : missingDegreeSeqMap.keySet()) {
            List<Graph> diff = missingDegreeSeqMap.get(degSeq);
            String degSeqString = Arrays.toString(degSeq);
            for (Graph g : diff) {
                System.out.println(count + "\tMISSING : " + degSeqString + "\t" + g);
                count++;
            }
        }
        count = 0;
        for (int[] degSeq : surplusDegreeSeqMap.keySet()) {
            List<Graph> diff = surplusDegreeSeqMap.get(degSeq);
            String degSeqString = Arrays.toString(degSeq);
            for (Graph g : diff) {
                System.out.println(count + "\tSURPLUS : " + degSeqString + "\t" + g);
                count++;
            }
        }
    }
    
    private int[] parse(String degreeSequenceString) {
        int end = degreeSequenceString.indexOf("]");
        String[] bits = degreeSequenceString.substring(1, end).split(","); 
        int[] degSeq = new int[bits.length];
        int i = 0;
        for (String bit : bits) {
            degSeq[i] = Integer.parseInt(bit.trim());
            i++;
        }
        return degSeq;
    }

    public List<Graph> diff(List<Graph> a, List<Graph> b) {
        // XXX - TODO, properly - perhaps move to GraphFileDiff?
        List<Graph> diffAB = new ArrayList<Graph>();
        Map<Graph, String> bMap = new HashMap<Graph, String>();
        for (Graph gA : a) {
            GraphSignature sigA = new GraphSignature(gA);
            String certA = sigA.toCanonicalString();
            if (bMap.containsValue(certA)) {
                continue;
            } else {
                for (Graph gB : b) {
                    GraphSignature sigB = new GraphSignature(gB);
                    String certB = sigB.toCanonicalString();
                    bMap.put(gB, certB);
                }
                if (bMap.containsValue(certA)) {
                    continue;
                } else {
                    diffAB.add(gA);
                }
            }
        }
        return diffAB;
    }
    
    public void reproduce(String filename) throws FileNotFoundException {
        Map<String, List<Graph>> degreeSeqMap = getDegSeqMap(filename);
        IsomorphCountingHandler duplicateHandler = new IsomorphCountingHandler(true, false);
        KiralyHHGenerator generator = new KiralyHHGenerator(duplicateHandler);
        for (String degreeSequenceString : degreeSeqMap.keySet()) {
            int[] degreeSequence = parse(degreeSequenceString);
            generator.generate(degreeSequence);
            List<Graph> kiralySet = duplicateHandler.getNonIsomorphicGraphs();
            for (Graph g : kiralySet) {
                System.out.println(g);
            }
        }
    }
    
    @Test
    public void generateEights() throws FileNotFoundException {
        reproduce("output/nauty/eights_nauty.txt");
    }
    
    @Test
    public void testNine_Fours() throws FileNotFoundException {
        testFile("output/mckay/nine_4.txt");
    }
    
    @Test
    public void testEights() throws FileNotFoundException {
//        testFile("output/mckay/eight_x.txt");
        testFile("output/nauty/eights_nauty.txt");
    }
    
    @Test
    public void testSeven_Fours() throws FileNotFoundException {
        testFile("output/mckay/seven_four.txt");
    }
    
    @Test
    public void testSevens() throws FileNotFoundException {
        testFile("output/mckay/seven_x.txt");
    }
    
    @Test
    public void testSixes() throws FileNotFoundException {
        testFile("output/mckay/six_x.txt");
    }
    
    @Test
    public void testFives() throws FileNotFoundException {
        testFile("output/mckay/five_x.txt");
    }
    
}
